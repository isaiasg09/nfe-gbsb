<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="nfe-title">
      <h1>Gerador de Nota Fiscal</h1>
      <p>Gere sua nota fiscal abaixo:</p>
    </div>

    <section class="notafiscal">
      <div class="nota-content1">
        <form action="" id="form">
          <div class="cliente_info">
            <h2>Informações do Cliente:</h2>

            <div class="row">
              <div>
                <label for="cliente_nome">Nome/Razão Social:</label>
                <input
                  type="text"
                  placeholder="Nome"
                  name="cliente_nome"
                  id="cliente_nome"
                  required
                />
              </div>

              <div>
                <label for="cnpj">CNPJ:</label>
                <input
                  type="text"
                  id="cnpj"
                  placeholder="00.000.000/0001-00"
                  required
                />
              </div>

              <div>
                <label for="telefone">Telefone:</label>
                <input
                  type="tel"
                  name="telefone"
                  id="telefone"
                  maxlength="15"
                  onkeyup="handlePhone(event)"
                  placeholder="(00) 00000-0000"
                  required
                />
              </div>

              <div>
                <label for="cep">CEP: </label>
                <input
                  type="text"
                  id="cep"
                  maxlength="9"
                  onkeyup="handleZipCode(event)"
                  placeholder="00000-000"
                  required
                />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="endereco">Endereço:</label>
                <input
                  type="text"
                  placeholder="Endereço"
                  name="endereco"
                  id="endereco"
                  required
                />
              </div>

              <div>
                <label for="bairro">Bairro:</label>
                <input
                  type="text"
                  id="bairro"
                  name="bairro"
                  placeholder="Bairro"
                  required
                />
              </div>

              <div>
                <label for="uf">UF:</label>
                <input
                  type="text"
                  name="uf"
                  id="uf"
                  placeholder="UF"
                  required
                />
              </div>

              <div>
                <label for="municipio">Município: </label>
                <input
                  type="text"
                  id="municipio"
                  placeholder="Município"
                  required
                />
              </div>
            </div>
          </div>

          <div class="operacao_info">
            <h2>Informações da Operação:</h2>

            <div class="row">
              <div>
                <label for="tipo_operacao">Tipo de operação:</label>
                <select name="tipo_operacao" id="tipo_operacao">
                  <option value="0" selected>Entrada</option>
                  <option value="1">Saida</option>
                </select>
              </div>

              <div>
                <label for="data_operacao">Data de entrada/saida:</label>
                <input type="date" id="data_operacao" required />
              </div>
            </div>
          </div>

          <div class="info-notas">
            <div class="nota-content2">
              <h2>Insira os Valores</h2>

              <div class="row">
                <div>
                  <label for="select_servicos">Selecione o serviço:</label>
                  <select
                    name="select_servicos"
                    id="select_servicos"
                    onchange="updateUnitPrice()"
                  >
                    <option value="manicure" selected>Manicure</option>
                    <option value="pedicure">Pedicure</option>
                    <option value="manicurepedicure">
                      Manicure + Pedicure
                    </option>
                    <option value="fibradevidro">Fibra de Vidro</option>
                    <option value="banhodegel">Banho de Gel</option>
                    <option value="gelnatips">Gel na Tips</option>
                    <option value="spadospes">Spa dos Pés</option>
                    <option value="manutencaofibra">Manutenção Fibra</option>
                    <option value="designdesobrancelha">
                      Design de Sobrancelha
                    </option>
                    <option value="designdesobrancelhacomhenna">
                      Design de Sobrancelha Com Henna
                    </option>
                    <option value="depilacaobuco">Depilação Buço</option>
                    <option value="depilacaofacialcompleta">
                      Depilação Facial Completa
                    </option>
                    <option value="extensaodecilios">Extensão De Cilios</option>
                    <option value="manutencaocilios">Manutenção Cilios</option>
                    <option value="lashlifting">Lash Lifting</option>
                    <option value="escova">Escova</option>
                    <option value="hidratacaoescova">
                      Hidratação + Escova
                    </option>
                    <option value="hidratacaofinalizacaocachoscurtosoumedios">
                      Hidratação + Finalização De Cachos (Curtos ou Medios)
                    </option>
                    <option value="hidratacaofinalizacaocachoslongos">
                      Hidratação + Finalização De Cachos (Longos)
                    </option>
                    <option value="babyliss">Babyliss (Adicional)</option>
                    <option value="depilacaoaxila">Depilação de Axila</option>
                    <option value="depilacaobuco">Depilação de Buço</option>
                    <option value="depilacaomeiaperna">
                      Depilação Meia Perna
                    </option>
                    <option value="depilacaopernainterna">
                      Depilação Perna Interna
                    </option>
                    <option value="depilacaodequeixo">
                      Depilação de Queixo
                    </option>
                    <option value="depilacaovirilhacompleta">
                      Depilação Virilha Completa
                    </option>
                    <option value="depilacaovirilhasimples">
                      Depilação Virilha Simples
                    </option>
                    <option value="depilacaonadegas">Depilação Nadegas</option>
                  </select>
                </div>

                <div>
                  <label for="quantidade">Quantidade:</label>
                  <input
                    type="number"
                    id="quantidade"
                    onchange="updateTotalPrice()"
                    value="1"
                    min="1"
                    max="100"
                  />
                </div>
              </div>

              <div class="row">
                <div>
                  <label for="valor_unitario">Valor Unitário:</label>
                  <input type="number" id="valor_unitario" disabled />
                </div>

                <div>
                  <label for="valor_total">Valor Total:</label>
                  <input type="number" id="valor_total" disabled />
                </div>

                <button class="add_button" onclick="addToTable()">
                  Adicionar
                </button>
              </div>
            </div>

            <div class="nota-content3">
              <h2>Produtos</h2>

              <table>
                <thead id="tabela_produtos">
                  <tr class="titles">
                    <th>Nome</th>

                    <th>Quantidade</th>

                    <th>Preço</th>

                    <th>Sel.</th>
                  </tr>
                </thead>

                <tbody></tbody>
              </table>

              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  width: 100%;
                  margin-top: 12px;
                  align-items: center;
                "
              >
                <button class="delete" onclick="removeFromTable()">
                  Remover
                </button>

                <div class="total">
                  <h3>Total:</h3>
                  <p id="preco_total">R$ 0,00</p>
                </div>
              </div>
            </div>
            <button
              class="nota-button"
              type="submit"
              onclick="verifyAllInputs()"
            >
              Enviar
            </button>
          </div>
        </form>
      </div>
    </section>

    <script>
      function verifyAllInputs() {
        var inputs = document.getElementsByTagName("input");
        for (let i = 0; i < inputs.length; i++) {
          if (inputs[i].value == "") {
            return alert("Preencha todos os campos!");
          }
        }

        if (servicos.length == 0) {
          return alert("Adicione pelo menos um serviço!");
        }

        pass();
      }

      function pass() {
        var nome = document.getElementById("cliente_nome").value;
        var cnpj = document.getElementById("cnpj").value;
        var telefone = document.getElementById("telefone").value;
        var cep = document.getElementById("cep").value;
        var endereco = document.getElementById("endereco").value;
        var bairro = document.getElementById("bairro").value;
        var uf = document.getElementById("uf").value;
        var municipio = document.getElementById("municipio").value;
        var tipoOperacaoSelect = document.getElementById("tipo_operacao");
        var tipo_operacao;
        for (i = 0; i < tipoOperacaoSelect.length; i++) {
          let option = tipoOperacaoSelect.options[i];
          if (option.selected) {
            tipo_operacao = option.value;
          }
        }
        var data_operacao = new Date(
          document.getElementById("data_operacao").value
        ).toLocaleDateString("pt-BR");
        // console.log(data_operacao);
        var items = servicos;

        var params = new URLSearchParams();
        params.append("nome", nome);
        params.append("cnpj", cnpj);
        params.append("telefone", telefone);
        params.append("cep", cep);
        params.append("endereco", endereco);
        params.append("bairro", bairro);
        params.append("uf", uf);
        params.append("municipio", municipio);
        params.append("tipo_operacao", tipo_operacao);
        params.append("data_operacao", data_operacao);
        params.append("items", JSON.stringify(items));
        params.append("preco_total", precoTotal);

        // console.log(params.toString());

        // setTimeout(() => {
        //   window.location.href = "nfe.html?" + params.toString();
        // }, 3000);
        window.open("nfe.html?" + params.toString(), "_blank");
      }

      // pass();
    </script>

    <script>
      var servicos = [];
      var precoTotal = 0;

      function updateUnitPrice() {
        const quantidadeInput = document.getElementById("quantidade");
        quantidade.value = 1;

        var select = document.getElementById("select_servicos");
        var item = select.options[select.selectedIndex].value;
        var valor_unitarioInput = document.getElementById("valor_unitario");

        var preco = 0;

        switch (item) {
          case "manicure":
            preco = 30;
            break;
          case "pedicure":
            preco = 30;
            break;
          case "manicurepedicure":
            preco = 50;
            break;
          case "fibradevidro":
            preco = 120;
            break;
          case "banhodegel":
            preco = 65;
            break;
          case "gelnatips":
            preco = 80;
            break;
          case "spadospes":
            preco = 50;
            break;
          case "manutencaofibra":
            preco = 60;
            break;
          case "designdesobrancelha":
            preco = 25;
            break;
          case "designdesobrancelhacomhenna":
            preco = 30;
            break;
          case "depilacaobuco":
            preco = 15;
            break;
          case "depilacaofacialcompleta":
            preco = 35;
            break;
          case "extensaodecilios":
            preco = 120;
            break;
          case "manutencaocilios":
            preco = 100;
            break;
          case "lashlifting":
            preco = 110;
            break;
          case "escova":
            preco = 40;
            break;
          case "hidratacaoescova":
            preco = 60;
            break;
          case "hidratacaofinalizacaocachoscurtosoumedios":
            preco = 40;
            break;
          case "hidratacaofinalizacaocachoslongos":
            preco = 60;
            break;
          case "babyliss":
            preco = 20;
            break;
          case "depilacaoaxila":
            preco = 20;
            break;
          case "depilacaomeiaperna":
            preco = 25;
            break;
          case "depilacaopernainterna":
            preco = 40;
            break;
          case "depilacaodequeixo":
            preco = 10;
            break;
          case "depilacaovirilhacompleta":
            preco = 60;
            break;
          case "depilacaovirilhasimples":
            preco = 40;
            break;
          case "depilacaonadegas":
            preco = 30;
            break;
          default:
            preco = 0;
        }

        valor_unitarioInput.value = preco;

        updateTotalPrice();
      }
      updateUnitPrice();

      function updateTotalPrice() {
        var quantidadeInput = document.getElementById("quantidade");
        var valor_unitarioInput = document.getElementById("valor_unitario");
        var valor_totalInput = document.getElementById("valor_total");

        var quantidade = quantidadeInput.value;
        var valor_unitario = valor_unitarioInput.value;

        var valor_total = quantidade * valor_unitario;

        valor_totalInput.value = valor_total;
      }

      function addToTable() {
        var select = document.getElementById("select_servicos");
        var itemOption = select.options[select.selectedIndex].value;
        var quantidade = document.getElementById("quantidade").value;
        var valor_unitario = document.getElementById("valor_unitario").value;
        var valor_total = document.getElementById("valor_total").value;

        var table = document.getElementById("tabela_produtos");
        var row = table.insertRow(-1);

        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);

        var item;

        for (let i = 0; i < select.length; i++) {
          let option = select.options[i];
          if (option.value == itemOption) {
            item = option.text;
          }
        }
        cell1.innerHTML = item;
        cell2.innerHTML = quantidade;
        cell3.innerHTML = valor_total;
        cell4.innerHTML = `<input type="checkbox" />`;

        servicos.push({
          item: item,
          quantidade: quantidade,
          valor_unitario: parseInt(valor_unitario),
          valor_total: parseInt(valor_total),
        });

        precoTotal += parseInt(valor_total);

        document.getElementById("preco_total").innerText =
          precoTotal.toLocaleString("pt-br", {
            style: "currency",
            currency: "BRL",
          });
      }

      function removeFromTable() {
        var table = document.getElementById("tabela_produtos");
        var rowCount = table.rows.length;

        servicos = servicos.filter((servico, index) => {
          var row = table.rows[index + 1];
          var chkbox = row.cells[3].getElementsByTagName("input")[0];
          return !chkbox.checked;
        });

        for (var i = 1; i < rowCount; i++) {
          var row = table.rows[i];
          var chkbox = row.cells[3].getElementsByTagName("input")[0];
          if (chkbox.checked) {
            precoTotal -= parseInt(row.cells[2].innerText);

            table.deleteRow(i);
            rowCount--;
            i--;
          }
        }

        document.getElementById("preco_total").innerText =
          precoTotal.toLocaleString("pt-br", {
            style: "currency",
            currency: "BRL",
          });
      }
    </script>

    <script>
      var form = document.getElementById("form");
      function handleForm(event) {
        event.preventDefault();
      }
      form.addEventListener("submit", handleForm);

      document.getElementById("data_operacao").valueAsDate = new Date();

      document.getElementById("cnpj").addEventListener("input", function (e) {
        var value = e.target.value;
        var rawValue = value.replace(/\D/g, ""); // Remove tudo que não é número

        // Verifica se o CNPJ tem 15 dígitos e se o primeiro dígito é '0'
        if (rawValue.length === 15 && rawValue.startsWith("0")) {
          // Verifica se, ao remover o '0', o restante é um CNPJ válido
          var potentialCNPJ = rawValue.substring(1);
          // Atualiza rawValue para o CNPJ sem o '0' inicial
          if (validaCNPJ(potentialCNPJ)) rawValue = potentialCNPJ;
        }

        var cnpjPattern = rawValue
          .replace(/^(\d{2})(\d)/, "$1.$2") // Adiciona ponto após o segundo dígito
          .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3") // Adiciona ponto após o quinto dígito
          .replace(/\.(\d{3})(\d)/, ".$1/$2") // Adiciona barra após o oitavo dígito
          .replace(/(\d{4})(\d)/, "$1-$2") // Adiciona traço após o décimo segundo dígito
          .replace(/(-\d{2})\d+?$/, "$1"); // Impede a entrada de mais de 14 dígitos
        e.target.value = cnpjPattern;
      });

      const handlePhone = (event) => {
        let input = event.target;
        input.value = phoneMask(input.value);
      };

      const phoneMask = (value) => {
        if (!value) return "";
        value = value.replace(/\D/g, "");
        value = value.replace(/(\d{2})(\d)/, "($1) $2");
        value = value.replace(/(\d)(\d{4})$/, "$1-$2");
        return value;
      };

      const handleZipCode = (event) => {
        let input = event.target;
        input.value = zipCodeMask(input.value);
      };

      const zipCodeMask = (value) => {
        if (!value) return "";
        value = value.replace(/\D/g, "");
        value = value.replace(/(\d{5})(\d)/, "$1-$2");
        return value;
      };

      function updateAddressInfo(resposta) {
        const enderecoInput = document.getElementById("endereco");
        const municipioInput = document.getElementById("municipio");
        const ufInput = document.getElementById("uf");
        const bairroInput = document.getElementById("bairro");

        bairroInput.value = resposta.bairro;
        municipioInput.value = resposta.localidade;
        enderecoInput.value = resposta.logradouro;
        ufInput.value = resposta.estado;
      }

      document.getElementById("cep").addEventListener("focusout", async () => {
        let str = document.getElementById("cep").value;
        var cep;

        // Using match with regEx
        let matches = str.match(/\d+/g);

        // Display output if number extracted
        if (matches) {
          cep = matches[0] + matches[1];
        }

        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);

        const responseCep = await response.json();

        if (responseCep.erro) {
          console.log("erro");
        } else {
          updateAddressInfo(responseCep);
        }
      });
    </script>
  </body>
</html>
